<polymer-element name="safe-app" on-animation-end="{{ animationEnd }}">
    <template>
        <style>
            :host {
                font-family: Lato, "Helvetica Neue", Helvetica, Arial, sans-serif;
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                top: 0;
                margin: auto;
                font-weight: 400;
                font-size: 18px;
                color: #444;
                -webkit-user-select: none;     
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
                background: #f5f5f5;

            }

            safe-header {
                position: absolute;
                z-index: 1;
                width: 100%;
            }

            .view {
                position: absolute;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                margin: auto;
            }

            ::-webkit-search-cancel-button {
                display: none;
            }

            *:focus {
                outline: none;
            }
        </style>
        <safe-header filterString="{{ filterString }}" record="{{ selected }}" on-back="{{ back }}" on-add="{{ addRecord }}"
            on-menu="{{ openMainMenu }}" on-record-menu="{{ openRecordMenu }}" editing="{{ editing }}"
            on-done="{{ editDone }}" on-cancel="{{ editCancel }}"></safe-header>
        <safe-list-view id="listView" class="view" collection="{{ collection }}" filterString="{{ filterString }}" selected="{{ selected }}"></safe-list-view>
        <safe-record-view id="recordView" class="view" on-back="{{ back }}" record="{{ selected }}" editing="{{ editing }}" style="display: none"></safe-record-view>
        <safe-dialog id="mainMenu">
            <div>Settings</div>
            <div>About</div>
            <div>Help</div>
        </safe-dialog>
        <safe-dialog id="recordMenu">
            <div on-click="{{ startEditing }}">Edit</div>
            <div class="negative" on-click="{{ confirmDelete }}" id="confirmButton">Delete</div>
        </safe-dialog>
        <safe-dialog id="confirmDialog">
            <div class="title">Are you sure you want to delete this record?</div>
            <div>Cancel</div>
            <div class="negative" on-click="{{ deleteRecord }}">Delete</div>
        </safe-dialog>
    </template>
    <script>
        Polymer("safe-app", {
            ready: function() {
                var self = this;
                require(["safe/model"], function(model) {
                    var coll = new model.Collection();
                    coll.fetch();
                    self.collection = coll;
                });
                // this.$.confirmButton.addEventListener("click", function() {
                //     this.confirmDelete.apply(self, arguments);
                // });
            },
            selectedChanged: function(oldRec, newRec) {
                if (newRec) {
                    this.openRecordView();
                }
            },
            confirmDelete: function() {
                this.$.confirmDialog.open();
            },
            deleteRecord: function() {
                this.collection.remove(this.selected);
                this.collection.save();
                this.openListView();
            },
            openRecordView: function() {
                this.$.listView.startOutAnimation();
                var self = this;

                setTimeout(function() {
                    self.$.recordView.startInAnimation();
                    self.$.recordView.style.display = "block";
                }, 300);
            },
            openListView: function() {
                this.$.recordView.startOutAnimation();

                var self = this;
                setTimeout(function() {
                    self.$.listView.startInAnimation();
                    self.$.listView.style.display = "block";
                }, 300);
            },
            saveRecord: function() {
                var record = this.selected;
                if (record) {
                    record.name = record.name || "Unnamed";
                    record.fields = record.fields.filter(function(field) {
                        return field.name || field.value;
                    });
                    delete record.isNew;
                    this.collection.save();
                }
            },
            addRecord: function() {
                var record = {
                    name: "",
                    fields: [],
                    isNew: true
                };
                this.collection.add(record);
                this.selected = record;
                this.editing = true;
            },
            back: function() {
                this.openListView();
            },
            animationEnd: function(event, detail, sender) {
                if (detail.direction == "out") {
                    event.srcElement.style.display = "none";
                    if (event.srcElement.id == "recordView") {
                        this.selected = null;
                    }
                }
            },
            openMainMenu: function() {
                this.$.mainMenu.open();
            },
            openRecordMenu: function() {
                this.$.recordMenu.open();
            },
            startEditing: function() {
                this.editCopy = {
                    name: this.selected.name,
                    fields: this.selected.fields.concat([])
                };
                this.editing = true;
            },
            editDone: function() {
                var isNew = this.selected.isNew;
                this.saveRecord();
                if (isNew) {
                    this.openListView();
                }

                this.editing = false;
                this.editCopy = null;
            },
            editCancel: function() {
                if (this.selected.isNew) {
                    this.collection.remove(this.selected);
                    this.openListView();
                } else {
                    this.collection.replace(this.selected, this.editCopy);
                    this.selected = this.editCopy;
                }
                this.editing = false;
                this.editCopy = null;
            }
        });
    </script>
</polymer-element>