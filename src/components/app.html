<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="header.html">
<link rel="import" href="dialog.html">
<link rel="import" href="list-view.html">
<link rel="import" href="record-view.html">
<link rel="import" href="password-view.html">
<link rel="import" href="lock-view.html">
<link rel="import" href="tags-view.html">
<link rel="import" href="import-view.html">

<polymer-element name="padlock-app" touch-action="pan-y" on-showheader="{{ showHeader }}"
    on-hideheader="{{ hideHeader }}" on-open="{{ dialogOpen }}" on-close="{{ dialogClose }}">
    <template>
        <!-- STYLES -->
        <link href="app.css" rel="stylesheet" type="text/css">
        <!-- HEADER -->
        <padlock-header id="header" view="{{ currentView }}" filterString="{{ filterString }}"></padlock-header>
        <!-- PASSWORD VIEW -->
        <padlock-password-view id="passwordView" class="view" on-enter="{{ newPwdEnter }}"></padlock-password-view>
        <!-- LOCK VIEW -->
        <padlock-lock-view id="lockView" class="view" on-enter="{{ pwdEnter }}"></padlock-lock-view>
        <!-- LIST VIEW -->
        <padlock-list-view id="listView" class="view" collection="{{ collection }}" filterString="{{ filterString }}"
            selected="{{ selected }}" on-add="{{ addRecord }}" on-menu="{{ openMainMenu }}"></padlock-list-view>
        <!-- RECORD VIEW -->
        <padlock-record-view id="recordView" class="view" on-save="{{ saveRecord }}" on-back="{{ recordViewBack }}"
            on-delete="{{ deleteRecord }}"></padlock-record-view>
        <!-- IMPORT VIEW -->
        <padlock-import-view id="importView" class="view" on-import="{{ saveImportedRecords }}"
            on-back="{{ importBack }}"></padlock-import-view>
        <!-- MAIN MENU -->
        <padlock-dialog id="mainMenu">
            <button>Settings</button>
            <button>About</button>
            <button>Help</button>
            <button on-tap="{{ openImportView }}">Import Records</button>
            <button on-tap="{{ lock }}">Lock App</button>
            <button on-tap="{{ changePassword }}">Change Password</button>
        </padlock-dialog>
        <!-- ADD RECORD -->
        <padlock-dialog id="addDialog">
            <div class="title">Add Record</div>
            <input id="addInput" placeholder="Enter Record Name"/>
            <button class="primary" on-tap="{{ confirmAddRecord }}">Add</button>
        </padlock-dialog>
        <!-- ALERT -->
        <padlock-dialog id="alertDialog">
            <div class="title" id="alertText"></div>
            <button on-tap="{{ dismissAlert }}">OK</button>
        </padlock-dialog>
    </template>
    <script>
        Polymer("padlock-app", {
            ready: function() {
                require(["padlock/model"], function(model) {
                    this.collection = new model.Collection();
                    // If there already is data in the local storage ask for password
                    // Otherwise start with choosing a new one
                    this.openView(this.collection.exists() ? this.$.lockView : this.$.passwordView);
                }.bind(this));
            },
            pwdEnter: function(event, detail, sender) {
                this.unlock(detail.password);
            },
            newPwdEnter: function(event, detail, sender) {
                this.collection.setPassword(detail.password);
                this.openView(this.$.listView);
            },
            //* Tries to unlock the current collection with the provided password
            unlock: function(password) {
                if (this.collection.fetch(password)) {
                    this.$.lockView.errorMessage = null;
                    this.openView(this.$.listView);
                } else {
                    this.$.lockView.errorMessage = "Wrong password!";
                }
            },
            //* Locks the collection and opens the lock view
            lock: function() {
                this.$.mainMenu.close();
                var coll = this.collection;
                // Add a small delay to avoid issues with the animation. TODO: Find a better solution?
                setTimeout(function() {
                    this.openView(this.$.lockView, function() {
                        coll.lock();
                    });
                }.bind(this), 10);
            },
            //* Change handler for the selected property; Opens the record view when record is selected
            selectedChanged: function(oldRec, newRec) {
                if (newRec) {
                    this.$.recordView.record = newRec;
                    // Add a small delay to avoid issues with the animation. TODO: Find a better solution?
                    setTimeout(function() {
                        this.openView(this.$.recordView);
                    }.bind(this), 10);
                }
            },
            /**
             * Opens the provided _view_
             * @param  {PadlockView} view
             * @param  {Function}    outCallback Called after out animation has finished
             * @param  {Function}    inCallback  Called after in animation has finished
             */
            openView: function(view, outCallback, inCallback) {
                var views = this.shadowRoot.querySelectorAll(".view").array();
                // Choose left or right animation based on the order the views
                // are included in the app
                var back = views.indexOf(view) < views.indexOf(this.currentView);

                // Hide current view (if any)
                if (this.currentView) {
                    this.currentView.hide(back ? "slideOutToRight": "slideOutToLeft", outCallback);
                }

                // Show new view
                view.show(back ? "slideInFromLeft": "slideInFromRight", inCallback);

                this.currentView = view;
            },
            //* Saves changes to the currently selected record (if any)
            saveRecord: function() {
                var record = this.selected;
                if (record) {
                    record.name = record.name || "Unnamed";
                    // Filter out fields that have neither a name nor a value
                    record.fields = record.fields.filter(function(field) {
                        return field.name || field.value;
                    });
                    // Save the changes
                    this.collection.save();
                }
            },
            //* Opens the dialog for adding a new record
            addRecord: function() {
                this.$.addInput.value = "";
                this.$.addDialog.open();
                // this.$.addInput.focus();
            },
            confirmAddRecord: function() {
                this.$.addInput.blur();
                this.$.addDialog.close();
                var record = {
                    name: this.$.addInput.value,
                    fields: []
                };

                this.collection.add(record);

                // select the newly added record (which will open the record view)
                this.selected = record;
                this.saveRecord();
            },
            //* Deletes the currently selected record (if any)
            deleteRecord: function() {
                this.collection.remove(this.selected);
                this.collection.save();
                this.recordViewBack();
            },
            recordViewBack: function(event, detail, sender) {
                this.selected = null;
                this.openView(this.$.listView);
            },
            //* Opens the main menu (duh)
            openMainMenu: function() {
                this.$.mainMenu.open();
            },
            //* Opens the change-password view
            changePassword: function() {
                this.$.mainMenu.close();
                this.$.passwordView.currentPassword = this.collection.store.password;
                // Add a small delay to avoid issues with the animation. TODO: Find a better solution?
                setTimeout(function() {
                    this.openView(this.$.passwordView);
                }.bind(this), 10);
            },
            //* Opens the import view
            openImportView: function() {
                this.$.mainMenu.close();
                // Add a small delay to avoid issues with the animation. TODO: Find a better solution?
                setTimeout(function() {
                    this.openView(this.$.importView);
                }.bind(this), 10);
            },
            //* Add the records imported with the import view to the collection
            saveImportedRecords: function(event, detail) {
                this.collection.add(detail.records);
                this.collection.save();
                this.alert(detail.records.length + " records imported!");
                this.openView(this.$.listView);
            },
            importBack: function() {
                this.openView(this.$.listView);
            },
            //* Triggers the headers scrim to match the scrim of the opened dialog
            dialogOpen: function(event, detail, sender) {
                this.$.header.scrim = true;
            },
            //* Removes the headers scrim
            dialogClose: function(event, detail, sender) {
                this.$.header.scrim = false;
            },
            //* Show an alert dialog with the provided message
            alert: function(msg) {
                this.$.alertText.innerText = msg;
                this.$.alertDialog.open();
            },
            dismissAlert: function() {
                this.$.alertDialog.close();
            }
        });
    </script>
</polymer-element>