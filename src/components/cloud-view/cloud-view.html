<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../padlock.html">
<link rel="import" href="../view/view.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../progress/progress.html">
<link rel="import" href="../view/view-styles.html">
<link rel="import" href="cloud-view-styles.html">

<dom-module id="padlock-cloud-view">

    <template>

        <style include="shared-styles"></style>
        <style include="view-styles"></style>
        <style include="cloud-view-styles"></style>

        <!-- <div class="status"> -->
        <!--     <span class="not&#45;connected" hidden$="{{ _isSet(settings.sync_key) }}">Not Connected</span> -->
        <!--     <span hidden$="{{ !_isSet(settings.sync_key) }}">Connected to <strong>{{ settings.sync_email }}</strong></span> -->
        <!--     <span hidden$="{{ !_isActivationPending(settings.sync_key, settings.sync_connected) }}">(activation pending)</span> -->
        <!-- </div> -->

        <!-- <section hidden> -->
        <!--     <div class="note"> -->
        <!--         <strong>Subscription expired</strong> &#45; It seems your Padlock Cloud subscription has expired which means that you will be able to download your data from the cloud but not update it or synchronize with any other devices. Renew your subscription now to unlock the full potential of Padlock Cloud! -->
        <!--     </div> -->
        <!--     <button>Buy Subscription</button> -->
        <!-- </section> -->

        <section hidden$="{{ _isSet(settings.sync_key) }}">
            <div class="note">
                Padlock Cloud provides a convenient way of synchronizing your data between all your devices. By
                securely storing your data in the cloud, it not only allows you to easily access it from anywhere
                but also acts as a backup in case you should loose your device or accidentally erase your data.
                Before being sent to our servers, your data is encrypted locally using your master password to make
                sure that nobody can read it - not even we!
            </div>
            <button on-tap="_connect">Get Started</button>
        </section>

        <section hidden$="{{ !_isActivationPending(settings.sync_key, settings.sync_connected) }}">
            <div class="note">
                <strong>Activation pending</strong> - You are almost done connecting this device!
                An email was sent to <strong>{{ settings.sync_email }}</strong> with further instructions.
                Didn't get it? Try again using the button below!
            </div>
            <button on-tap="_connect">Try Again</button>
        </section>

        <section hidden$="{{ !settings.sync_connected }}">
            <div class="note">
                <strong>Connected</strong> - This device is connected to the Padlock Cloud account <strong>{{ settings.sync_email }}</strong>.
                Connect all your devices with the same account to easily synchronize your data between them!
            </div>
            <button on-tap="_synchronize">Synchronize</button>
            <button on-tap="_resetRemoteData">Reset Data</button>
            <button on-tap="_disconnect">Disconnect</button>
            <padlock-toggle-button value="{{ settings.sync_auto }}" label="Auto Sync"></padlock-toggle-button>
        </section>

        <padlock-progress>Connecting...</padlock-progress>

    </template>

    <script>
    /* global Polymer, padlock */

    (function(Polymer, ViewBehavior, CloudSource) {
        "use strict";

        Polymer({
            is: "padlock-cloud-view",
            behaviors: [ViewBehavior],
            ready: function() {
                this.headerTitle = "Padlock Cloud";
                this.leftHeaderIcon = "left";
                this.rightHeaderIcon = "";
            },
            properties: {
                settings: Object,
                _activated: {
                    type: Boolean,
                    value: false
                }
            },
            observers: [
                "_credentialsChanged(settings.sync_email, settings.sync_key)"
            ],
            //* Opens the dialog for connecting to the Padlock Cloud
            _connect: function() {
                this.fire("open-form", {
                    components: [
                        {element: "input", type: "email", placeholder: "Email Address", name: "email",
                            value: this.settings.sync_email, autofocus: true},
                        {element: "button", label: "Connect", submit: true},
                        {element: "button", label: "Cancel", cancel: true}
                    ],
                    title: "Connect to Padlock Cloud",
                    submit: this._requestAuthToken.bind(this)
                });
            },
            _disconnect: function() {
                this.fire("open-form", {
                    components: [
                        {element: "button", label: "Disconnect", submit: true},
                        {element: "button", label: "Cancel", cancel: true}
                    ],
                    title: "Are you sure you want to disconnect from Padlock Cloud?",
                    submit: function() {
                        this.set("settings.sync_connected", false);
                        this.set("settings.sync_key", "");
                        this.set("settings.sync_email", "");
                    }.bind(this)
                });
            },
            //* Requests an api key from the cloud api with the entered email and device name
            _requestAuthToken: function(data) {
                var email = data.email;

                if (!email) {
                    var message = "Please enter an email address!";
                    this.fire("notify", {
                        message: message,
                        duration: 2000
                    });
                    return;
                }

                this.set("settings.sync_email", email);

                // Show progress indicator
                this.$$("padlock-progress").show();

                var cloudSource = new CloudSource(this.settings.sync_host);
                cloudSource.requestAuthToken(email, true, function(token) {
                    this.$$("padlock-progress").hide();
                    // We're getting back the api key directly, but it will valid only
                    // after the user has visited the activation link in the email he was sent
                    this.set("settings.sync_connected", false);
                    this.set("settings.sync_key", token);
                    this._alert("Almost done! An email was sent to " + email + " with further instructions.");
                }.bind(this), function(e) {
                    this.$$("padlock-progress").hide();
                    this.fire("error", e);
                }.bind(this));
            },
            _isActivationPending: function() {
                return this.settings.sync_key && !this.settings.sync_connected;
            },
            _resetRemoteData: function() {
                this.fire("open-form", {
                    components: [
                        {element: "button", label: "Reset", submit: true},
                        {element: "button", label: "Cancel", cancel: true}
                    ],
                    title: "Are you sure you want to reset all your data on Padlock Cloud?",
                    submit: this._requestResetRemoteData.bind(this)
                });
            },
            _requestResetRemoteData: function() {
                var email = this.settings.sync_email;
                var cloudSource = new CloudSource(this.settings.sync_host, email);

                this.$$("padlock-progress").show();

                cloudSource.requestDataReset(function() {
                    this.$$("padlock-progress").hide();
                    this._alert("Almost done! An email was sent to " + email + " with further instructions.");
                }.bind(this), function(e) {
                    this.$$("padlock-progress").hide();
                    this.fire("error", e);
                }.bind(this));
            },
            //* Shows an alert dialog with a given _message_
            _alert: function(message) {
                this.fire("alert", {message: message});
            },
            _testCredentials: function(poll) {
                var cloudSource = new CloudSource(this.settings.sync_host,
                    this.settings.sync_email, this.settings.sync_key);

                cloudSource.testCredentials(function(connected) {
                    this.set("settings.sync_connected", connected);

                    if (connected) {
                        this._connectionSuccess();
                    }

                    if (!connected && poll && this.settings.sync_key) {
                        clearTimeout(this._testCredsTimeout);
                        this._testCredsTimeout = setTimeout(this._testCredentials.bind(this, true), 1000);
                    }
                }.bind(this), this.fire.bind(this, "error"));
            },
            _stopTestCredentials: function() {
                clearTimeout(this._testCredsTimeout);
            },
            _credentialsChanged: function() {
                if (this.settings.sync_key && !this.settings.sync_connected) {
                    this._testCredentials(this.showing);
                }
            },
            _showingChanged: function() {
                if (this.showing && this.settings.sync_key && !this.settings.sync_connected) {
                    this._testCredentials(true);
                } else if (!this.showing) {
                    this._stopTestCredentials();
                }
            },
            _isSet: function(val) {
                return !!val;
            },
            leftHeaderButton: function() {
                this.fire("back");
            },
            _synchronize: function() {
                this.fire("synchronize");
            },
            _connectionSuccess: function() {
                this.fire("open-form", {
                    components: [
                        {element: "button", label: "Synchronize Now", tap: this._synchronize.bind(this), submit: true}
                    ],
                    title: "You have successfully connected to Padlock Cloud! " +
                        "You can now start synchronizing your data!"
                });
            }
        });

    })(Polymer, padlock.ViewBehavior, padlock.CloudSource);

    </script>

</dom-module>
