<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="dialog.html">
<link rel="import" href="view.html">

<polymer-element name="padlock-record-view" extends="padlock-view" attributes="record editing">
    <template>
        <!-- STYLES -->
        <link href="record-view.css" rel="stylesheet" type="text/css">
        <div id="animated">
            <!-- FIELD LIST -->
            <template if="{{ record }}">
                <template repeat="{{ field in record.fields }}">
                    <div class="field" on-tap="{{ openFieldMenu }}">
                        <div class="value">{{ field.value }}</div>
                        <div class="label">{{ field.name }}</div>
                    </div>
                </template>
            </template>
        </div>
        <!-- RECORD OPTIONS -->
        <padlock-dialog id="menu">
            <button on-tap="{{ editName }}">Edit Name</button>
            <button on-tap="{{ editTags }}">Edit Tags</button>
            <button on-tap="{{ addField }}">Add Field</button>
            <button on-tap="{{ deleteRecord }}" id="confirmButton">Delete Record</button>
        </padlock-dialog>
        <!-- DELETE CONFIRM DIALOG -->
        <padlock-dialog id="confirmDeleteDialog">
            <div class="title">Are you sure you want to delete this record?</div>
            <button class="negative" on-tap="{{ confirmDelete }}">Delete</button>
            <button on-tap="{{ cancelDelete }}">Cancel</button>
        </padlock-dialog>
        <!-- EDIT NAME DIALOG -->
        <padlock-dialog id="editNameDialog">
            <div class="title">Edit Name</div>
            <input id="nameInput" placeholder="Enter Record Name"/>
            <button class="primary" on-tap="{{ confirmEditName }}">Save</button>
        </padlock-dialog>
        <!-- FIELD CONTEXT MENU -->
        <padlock-dialog id="fieldMenu">
            <div class="title">{{ selectedField.name }}</div>
            <input id="fieldValueInput" placeholder="Enter Content" />
            <input id="fieldNameInput" placeholder="Enter Name" style="display: none"/>
            <button class="primary" on-tap="{{ confirmEditField }}">Save Changes</button>
            <button on-tap="{{ removeField }}">Remove Field</button>
        </padlock-dialog>
        <!-- ADD FIELD DIALOG -->
        <padlock-dialog id="addFieldDialog">
            <div class="title">Add Field</div>
            <input id="newValueInput" placeholder="Enter Content" />
            <input id="newFieldNameInput" placeholder="Enter Label" />
            <button class="primary" on-tap="{{ confirmAddField }}">Add</button>
        </padlock-dialog>
        <!-- REMOVE FIELD CONFIRM DIALOG -->
        <padlock-dialog id="confirmRemoveFieldDialog">
            <div class="title">Are you sure you want to remove this field?</div>
            <button class="negative" on-tap="{{ confirmRemoveField }}">Remove</button>
            <button on-tap="{{ cancelRemoveField }}">Cancel</button>
        </padlock-dialog>
    </template>
    <script>
        Polymer('padlock-record-view', {
            headerOptions: {
                show: true,
                leftIconShape: "arrow-left",
                rightIconShape: "more"
            },
            titleText: "",
            leftHeaderButton: function() {
                this.fire("back");
            },
            rightHeaderButton: function() {
                this.$.menu.open = true;
            },
            getAnimationElement: function() {
                return this.$.animated;
            },
            deleteRecord: function() {
                this.$.menu.open = false;
                this.$.confirmDeleteDialog.open = true;
            },
            confirmDelete: function() {
                this.$.confirmDeleteDialog.open = false;
                this.fire("delete");
            },
            cancelDelete: function() {
                this.$.confirmDeleteDialog.open = false;
            },
            editName: function() {
                this.$.menu.open = false;
                this.$.nameInput.value = this.record.name;
                this.$.editNameDialog.open = true;
                this.$.nameInput.select();
            },
            confirmEditName: function() {
                this.$.editNameDialog.open = false;
                this.record.name = this.$.nameInput.value;
                this.fire("save");
            },
            addField: function() {
                this.$.menu.open = false;
                this.$.newValueInput.value = "";
                this.$.newFieldNameInput.value = "";
                this.$.addFieldDialog.open = true;
            },
            confirmAddField: function() {
                this.$.addFieldDialog.open = false;
                var field = {
                    name: this.$.newFieldNameInput.value,
                    value: this.$.newValueInput.value
                };
                this.record.fields.push(field);
                this.fire("save");
            },
            confirmEditField: function() {
                this.$.fieldMenu.open = false;
                this.selectedField.value = this.$.fieldValueInput.value;
                this.selectedField.name = this.$.fieldNameInput.value;
                this.fire("save");
            },
            openFieldMenu: function(event, detail, sender) {
                this.selectedField = sender.templateInstance.model.field;
                this.$.fieldValueInput.value = this.selectedField.value;
                this.$.fieldNameInput.value = this.selectedField.name;
                this.$.fieldMenu.open = true;
                this.$.fieldValueInput.select();
            },
            removeField: function() {
                this.$.fieldMenu.open = false;
                this.$.confirmRemoveFieldDialog.open = true;
            },
            confirmRemoveField: function() {
                this.$.confirmRemoveFieldDialog.open = false;
                var util = require("padlock/util");
                this.record.fields = util.remove(this.record.fields, this.record.fields.indexOf(this.selectedField));
                this.fire("save");
            },
            cancelRemoveField: function() {
                this.$.confirmRemoveFieldDialog.open = false;
            },
            recordChanged: function() {
                this.titleText = this.record.name;
            }
        });
    </script>
</polymer-element>