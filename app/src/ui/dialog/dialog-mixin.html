<link rel="import" href="../base/base.html">
<link rel="import" href="../generator/generator.html">
<link rel="import" href="dialog-alert.html">
<link rel="import" href="dialog-confirm.html">
<link rel="import" href="dialog-prompt.html">
<link rel="import" href="dialog-options.html">

<script>
(() => {

const { wait } = padlock.util;

const dialogElements = {};

let lastDialogPromise = Promise.resolve();
let currentDialog;

function getDialog(elName) {
    let el = dialogElements[elName];

    if (!el) {
        dialogElements[elName] = el = document.createElement(elName);
        document.body.appendChild(el);
    }

    return el;
}

function lineUpDialog(dialog, fn) {
    const promise = lastDialogPromise
        .then(() => {
            currentDialog = dialog;
            return fn();
        });

    lastDialogPromise = promise
        .then(() => wait(500));

    return promise;
}

padlock.DialogMixin = (superClass) => {

    return class DialogMixin extends superClass {

        alert(message, buttonLabel) {
            const dialog = getDialog("pl-dialog-alert");
            return lineUpDialog(dialog, () => dialog.alert(message, buttonLabel));
        }

        confirm(message, confirmLabel, cancelLabel) {
            const dialog = getDialog("pl-dialog-confirm");
            return lineUpDialog(dialog, () => dialog.confirm(message, confirmLabel, cancelLabel));
        }

        prompt(message, placeholder, type, confirmLabel, cancelLabel, preventDismiss, verify) {
            const dialog = getDialog("pl-dialog-prompt");
            return lineUpDialog(dialog, () => {
                return dialog.prompt(message, placeholder, type, confirmLabel, cancelLabel, preventDismiss, verify);
            });
        }

        choose(message, options, preventDismiss=true) {
            const dialog = getDialog("pl-dialog-options");
            dialog.preventDismiss = preventDismiss;
            return lineUpDialog(dialog, () => dialog.choose(message, options));
        }

        generate() {
            const dialog = getDialog("pl-generator");
            return lineUpDialog(dialog, () => dialog.generate());
        }

        getSingleton(elName) {
            return getDialog(elName);
        }

        clearDialogs() {
            if (currentDialog) {
                currentDialog.open = false;
            }
            lastDialogPromise = Promise.resolve();
        }

        promptPassword(password, msg, confirmLabel, cancelLabel) {
            return this.prompt(msg, $l("Enter Password"), "password", confirmLabel, cancelLabel, true, (pwd) => {
                if (!pwd) {
                    return Promise.reject($l("Please enter a password!"));
                } else if (pwd !== password) {
                    return Promise.reject($l("Wrong password. Please try again!"));
                } else {
                    return Promise.resolve(true);
                }
            });
        }

        promptForgotPassword() {
            return this.confirm($l(
                "Forgot your password? For security reasons don't keep a record of your master " +
                "password so unfortunately we cannot help you recover it. You can reset your password, " +
                "but your data will be lost in the process."
            ), $l("Reset Password"), $l("Keep Trying"))
                .then((confirmed) => {
                    return confirmed && this.confirm($l(
                        "Are you sure you want to reset your password? " +
                        "WARNING: All your data will be lost!"
                    ), $l("Reset Password"));
                });
        }

    };
};

})();
</script>
