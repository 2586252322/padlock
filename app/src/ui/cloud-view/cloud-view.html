<link rel="import" href="../../styles/shared.html">
<link rel="import" href="../animation/animation.html">
<link rel="import" href="../base/base.html">
<link rel="import" href="../data/data.html">
<link rel="import" href="../dialog/dialog-mixin.html">
<link rel="import" href="../icon/icon.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../loading-button/loading-button.html">
<link rel="import" href="../locale/locale.html">
<link rel="import" href="../notification/notification.html">
<link rel="import" href="../sync/sync.html">
<link rel="import" href="../toggle/toggle-button.html">

<dom-module id="pl-cloud-view">

    <template>

        <style include="shared">
            :host {
                display: flex;
                flex-direction: column;
                @apply --fullbleed;
            }

            main {
                background: var(--color-quaternary);
            }

            button, pl-toggle-button {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }

            section {
                transform: translate3d(0, 0, 0);
            }

            .account {
                height: 90px;
            }

            .account-info {
                flex: 1;
                padding: 15px;
                text-align: center;
            }

            .account-email {
                font-size: 110%;
                font-weight: bold;
                @apply --ellipsis;
                margin-bottom: 10px;
            }

            .account-stats {
                font-size: var(--font-size-tiny);
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .account-stats pl-icon {
                width: 20px;
                height: 20px;
            }

            .account-sync {
                height: auto;
                width: 70px;
                font-size: 25px;
            }

            #emailInput {
                text-align: center;
            }

            #customUrlInput {
                width: 100%;
                padding-left: 15px;
                padding-right: 15px;
            }

            #customUrlInput:not([invalid]) + .warning {
                display: none;
            }

            section.highlight {
                @apply --hero-gradient;
                background: linear-gradient(rgb(89, 198, 255) 0%, rgb(7, 124, 185) 100%);
                color: var(--color-background);
                text-shadow: rgba(0, 0, 0, 0.2) 0px 2px 0px;
                border: none;
                --border-color: rgba(255, 255, 255, 0.3);
            }

            section.highlight button, section.highlight pl-loading-button {
                font-weight: bold;
            }

            section.highlight.warning {
                background: linear-gradient(180deg, #f49300 0%, #f25b00 100%);
            }

            .info {
                display: flex;
                align-items: center;
            }

            .info-icon {
                width: 80px;
                height: 80px;
                font-size: 60px;
                margin: 10px 0 10px 10px;
            }

            .info-body {
                padding: 20px 15px 20px 10px;
                flex: 1;
            }

            .info-title {
                font-size: 120%;
                font-weight: bold;
                margin-bottom: 5px;
            }

            .info-text {
                font-size: var(--font-size-small);
            }

            .url-warning {
                font-size: var(--font-size-small);
                text-align: center;
                padding: 15px;
                border-top: solid 1px var(--border-color);
                color: var(--color-error);
            }

            pl-icon[icon=refresh][spin] {
                background: transparent !important;
                pointer-events: none;
            }

            pl-icon[spin]::after, pl-icon[spin]::before {
                display: none !important;
            }
        </style>

        <header>
            <pl-icon icon="close" class="tap" on-click="_back"></pl-icon>
            <div class="title">[[ $l("My Account") ]]</div>
            <pl-icon icon="logout" class="tap" on-click="_logout"></pl-icon>
        </header>

        <main>

            <section class="section highlight" hidden$="[[ settings.syncConnected ]]">
                <div class="info">
                    <pl-icon class="info-icon" icon="cloud"></pl-icon>
                    <div class="info-body">
                        <div class="info-title">[[ $l("Padlock Online") ]]</div>
                        <div class="info-text">[[ loginInfoText() ]]</div>
                    </div>
                </div>
                <pl-input id="emailInput" type="email" placeholder="[[ $l('Enter Email Address') ]]" value="[[ settings.syncEmail ]]"
                    select-on-focus required on-enter="_login"></pl-input>
                <pl-loading-button id="loginButton" class="tap" on-click="_login">[[ $l("Log In") ]]</pl-loading-button>
            </section>

            <section class="horizontal account" hidden$="[[ !settings.syncConnected ]]">
                <div class="account-info">
                    <div class="account-email">[[ settings.syncEmail ]]</div>
                    <div class="account-stats">
                        <pl-icon icon="record"></pl-icon>
                        <span>[[ records.length ]]</span>
                        <pl-icon icon="mobile"></pl-icon>
                        <span>[[ settings.account.devices.length ]]</span>
                        <pl-icon icon="refresh"></pl-icon>
                        <span>[[ lastSync ]]</span>
                    </div>
                </div>
                <pl-icon class="account-sync tap" icon="refresh" spin$="[[ isSynching ]]" on-click="synchronize"></pl-icon>
            </section>

            <section class="highlight" hidden$="[[ !isTrialing(settings.syncConnected, settings.syncSubStatus) ]]">
                <div class="info">
                    <pl-icon class="info-icon" icon="time"></pl-icon>
                    <div class="info-body">
                        <div class="info-title">[[ $l("Trialing ({0} days left)", remainingTrialDays) ]]</div>
                        <div class="info-text">[[ trialingMessage(remainingTrialDays) ]]</div>
                    </div>
                </div>
                <button class="tap" on-click="_trialingBuySubscription">[[ $l("Upgrade Now") ]]</button>
            </section>

            <section class="highlight warning" hidden$="[[ !isTrialExpired(settings.syncConnected, settings.syncSubStatus) ]]">
                <div class="info">
                    <pl-icon class="info-icon" icon="error"></pl-icon>
                    <div class="info-body">
                        <div class="info-title">[[ $l("Trial Expired") ]]</div>
                        <div class="info-text">[[ trialExpiredMessage() ]]</div>
                    </div>
                </div>
                <button class="tap" on-click="_readonlyBuySubscription">[[ $l("Upgrade Now") ]]</button>
            </section>

            <section class="highlight warning" hidden$="[[ !isSubUnpaid(settings.syncConnected, settings.syncSubStatus) ]]">
                <div class="info">
                    <pl-icon class="info-icon" icon="error"></pl-icon>
                    <div class="info-body">
                        <div class="info-title">[[ $l("Payment Failed") ]]</div>
                        <div class="info-text">[[ subUnpaidMessage() ]]</div>
                    </div>
                </div>
                <button class="tap" on-click="updatePaymentMethod">[[ $l("Update Payment Method") ]]</button>
                <button class="tap" on-click="_contactSupport">[[ $l("Contact Support") ]]</button>
            </section>

            <section class="highlight warning" hidden$="[[ !isSubCanceled(settings.syncConnected, settings.syncSubStatus) ]]">
                <div class="info">
                    <pl-icon class="info-icon" icon="error"></pl-icon>
                    <div class="info-body">
                        <div class="info-title">[[ $l("Subscription Canceled") ]]</div>
                        <div class="info-text">[[ subCanceledMessage() ]]</div>
                    </div>
                </div>
                <button class="tap" on-click="reactivateSubscription">[[ $l("Reactivate Subscription") ]]</button>
            </section>

            <section hidden$="[[ !settings.syncConnected ]]">
                <div class="section-header">[[ $l("{0} Devices Connected", settings.account.devices.length) ]]</div>
                <div class="devices">
                    <template is="dom-repeat" items="[[ settings.account.devices ]]">
                        <div class="section-row">
                            <div class="section-row-label">[[ item.description ]]</div>
                            <pl-icon icon="delete" class="tap" on-click="_revokeDevice" disabled$="[[ _isCurrentDevice(item) ]]"></pl-icon>
                        </div>
                    </template>
                </div>
            </section>

            <section hidden$="[[ !isSubActive(settings.syncConnected, settings.syncSubStatus) ]]">
                <button class="tap" on-click="cancelSubscription">[[ $l("Cancel Subscription") ]]</button>
            </section>

            <section hidden$="[[ settings.syncConnected ]]">
                <pl-toggle-button active="{{ settings.syncCustomHost }}" label="[[ $l('Use Custom Server') ]]" reverse
                    on-change="_customHostChanged" class="tap"></pl-toggle-button>
                <div class="tap" hidden$="[[ !settings.syncCustomHost ]]">
                    <pl-input id="customUrlInput" placeholder="[[ $l('Enter Custom URL') ]]"
                        value="{{ settings.syncHostUrl }}" pattern="^https://[^\s/$.?#].[^\s]*$"
                        required on-change="settingChanged"></pl-input>
                    <div class="url-warning">
                        <strong>[[ $l("Invalid URL") ]]</strong> -
                        [[ $l("Make sure that the URL is of the form https://myserver.tld:port. Note that a https connection is required.") ]]
                    </div>
                </div>
            </section>

        </main>

        <div class="rounded-corners"></div>

    </template>

    <script>
(() => {

const { LocaleMixin, DialogMixin, NotificationMixin, DataMixin, SyncMixin, AnimationMixin, BaseElement } = padlock;
const { applyMixins } = padlock.util;

class CloudView extends applyMixins(
    BaseElement,
    DataMixin,
    SyncMixin,
    LocaleMixin,
    DialogMixin,
    NotificationMixin,
    AnimationMixin
) {

    static get is() { return "pl-cloud-view"; }

    ready() {
        super.ready();
        this.listen("data-loaded", () => this.animate());
        this.listen("sync-connect-start", () => this.animate());
        this.listen("sync-connect-cancel", () => this.animate());
        this.listen("sync-connect-success", () => this.animate());
        this.listen("sync-disconnect", () => this.animate());
    }

    animate() {
        this.animateCascade(this.root.querySelectorAll("section:not([hidden])"), { initialDelay: 200 });
    }

    focusEmailInput() {
        this.$.emailInput.focus();
    }

    _credentialsChanged() {
        if (this.isActivationPending() && !this._testCredsTimeout) {
            // Wait 1 minute, then poll every 10 seconds
            this._testCredsTimeout = setTimeout(() => this.testCredentials(10000), 60000);
            // Also test on first focus event since there is a chance the user is just returning
            // from his email client / web browsers
            window.addEventListener("focus", () => this.testCredentials(), { once: true });
        } else if (!this.isActivationPending()) {
            clearTimeout(this._testCredsTimeout);
            this._testCredsTimeout = null;
        }
    }

    _back() {
        this.dispatchEvent(new CustomEvent("cloud-back"));
    }

    _logout() {
        this.confirm(
            $l("Are you sure you want to log out?"),
            $l("Log Out")
        ).then((confirmed) => {
            if (confirmed) {
                this.disconnectCloud();
            }
        });
    }

    _customHostChanged() {
        if (this.settings.syncCustomHost) {
            this.confirm(
                $l("Are you sure you want to use a custom server for synchronization? " +
                    "This option is only recommended for advanced users!"),
                $l("Continue"))
                .then((confirmed) => {
                    if (confirmed) {
                        this.settingChanged();
                    } else {
                        this.set("settings.syncCustomHost", false);
                    }
                });
        } else {
            this.settingChanged();
        }
    }

    _refresh() {
        if (this.isActivationPending()) {
            this.$.refreshButton.start();
            this.testCredentials()
                .then((connected) => {
                    if (connected) {
                        this.$.refreshButton.success();
                    } else {
                        this.$.refreshButton.fail();
                    }
                })
                .catch(() => this.$.refreshButton.fail());
        } else {
            this.synchronize();
        }
    }

    _trialingBuySubscription() {
        // this.openDashboard("subscribe", "app-2");
        this.buySubscription();
    }

    _readonlyBuySubscription() {
        // this.openDashboard("subscribe", "app-3");
        this.buySubscription();
    }

    _manageAccount() {
        this.openDashboard("", "app-1");
    }

    _login() {
        if (this._submittingEmail) {
            return;
        }

        this.$.loginButton.start();

        if (this.$.emailInput.invalid) {
            this.alert($l("Please enter a valid email address!"))
                .then(() => this.$.emailInput.focus());
            this.$.loginButton.fail();
            return;
        }

        this._submittingEmail = true;

        this.connectCloud(this.$.emailInput.value)
            .then(() => {
                this._submittingEmail = false;
                this.$.loginButton.success();
                return this.promptLoginCode();
            })
            .then(() => {
                if (this.settings.syncConnected) {
                    this.synchronize();
                }
            })
            .catch(() => {
                this._submittingEmail = false;
                this.$.loginButton.fail();
            });

    }

    _isCurrentDevice(device) {
        return this.settings.syncId === device.tokenId;
    }

    _revokeDevice(e) {
        const device = e.model.item;
        this.confirm($l("Do you want to revoke access to for the device \"{0}\"?", device.description))
            .then((confirmed) => {
                if (confirmed) {
                    this.cloudSource.source.revokeAuthToken(device.tokenId)
                        .then(() => {
                            this.refreshAccount();
                            this.alert($l("Access for {0} revoked successfully!", device.description))
                        });
                }
            });
    }

    _contactSupport() {
        window.open("mailto:support@padlock.io", "_system");
    }

}

window.customElements.define(CloudView.is, CloudView);

})();
    </script>

</dom-module>
