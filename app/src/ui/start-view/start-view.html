<link rel="import" href="../../styles/shared.html">
<link rel="import" href="../animation/animation.html">
<link rel="import" href="../base/base.html">
<link rel="import" href="../dialog/dialog-mixin.html">
<link rel="import" href="../data/data.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../loading-button/loading-button.html">
<link rel="import" href="../locale/locale.html">

<dom-module id="pl-start-view">

    <template>

        <style include="shared">
            @keyframes rumble {
                25% {transform: translate(5px, 0);}
                50% {transform: translate(-5px, -3px);}
                75% {transform: translate(5px, 2px);}
            }

            @keyframes bounceIn {
                from { transform: scale(0.1); opacity: 0; }
                50% { transform: scale(1.05); opacity: 1; }
                to { transform: scale(1); opacity: 1; }
            }

            @keyframes reveal {
                from { transform: translate(0, 30px); opacity: 0; }
                to { opacity: 1; }
            }

            :host {
                --color-background: var(--color-primary);
                --color-foreground: var(--color-tertiary);
                --color-highlight: var(--color-secondary);
                @apply --fullbleed;
                color: var(--color-foreground);
                display: flex;
                flex-direction: column;
                z-index: 5;
                text-align: center;
                text-shadow: rgba(0, 0, 0, 0.15) 0 2px 0;
            }

            main {
                @apply --fullbleed;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .shutter {
                flex: 1;
                transform: translate3d(0, 0, 0);
                transition: transform 0.4s cubic-bezier(1, 0, 0.2, 1);
            }

            .shutter.top {
                background: linear-gradient(180deg, #59c6ff 0%, #077cb9 200%);
            }

            .shutter.bottom {
                background: linear-gradient(180deg, #59c6ff -100%, #077cb9 100%);
            }

            .form-box {
                width: 100%;
                max-width: 300px;
                border: solid 1px var(--shade-3-color);
                border-radius: 12px;
                overflow: hidden;
                display: flex;
                margin-top: 20px;
            }

            .hero {
                display: block;
                font-size: 110px;
                height: 120px;
                width: 120px;
                margin-bottom: 30px;
                opacity: 0.9;
            }

            .welcome-title {
                font-size: 120%;
                font-weight: bold;
                padding: 10px;
            }

            .welcome-subtitle {
                max-width: 300px;
                padding: 10px;
            }

            .start-button {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                text-align: center;
                font-weight: bold;
            }

            .start-button pl-icon {
                position: relative;
                top: 2px;
            }

            .form-box pl-input, .form-box .input-wrapper {
                flex: 1;
                text-align: center;
                --pl-input-placeholder: {
                    opacity: 0.4;
                };
            }

            .form-box pl-loading-button {
                width: var(--row-height);
            }

            .form-box pl-loading-button pl-icon {
                margin-left: 6px;
            }

            .input-wrapper {
                position: relative;
            }

            .input-wrapper pl-icon {
                position: absolute;
                width: var(--row-height);
                height: var(--row-height);
                top: 0;
                right: 0;
                bottom: 0;
                margin: auto 0;
                opacity: 0.8;
            }

            .strength-meter {
                font-size: 12px;
                font-weight: bold;
                margin-top: 10px;
                height: 16px;
            }

            .enter-button {
                font-weight: bold;
            }

            .hint {
                font-size: var(--font-size-tiny);
                width: 100%;
                max-width: 300px;
                padding: 20px;
                margin-top: 20px;
            }

            .hint pl-icon {
                width: 1em;
                height: 1em;
                vertical-align: middle;
            }

            :host(:not([_mode="get-started"])) .get-started,
            :host(:not([_mode="unlock"])) .unlock {
                display: none;
            }

            .get-started-steps {
                width: 100%;
                height: 250px;
                position: relative;
            }

            .get-started-step {
                @apply --fullbleed;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .get-started-step:not(.center) {
                pointer-events: none;
            }

            .get-started-step > * {
                transform: translate3d(0, 0, 0);
                transition: transform 0.5s, opacity 0.2s;
            }

            .get-started-step > :nth-child(2) {
                transition-delay: 0.1s;
            }

            .get-started-step > :nth-child(3) {
                transition-delay: 0.2s;
            }

            .get-started-step:not(.center) > * {
                opacity: 0;
            }

            .get-started-step.left > * {
                transform: translate3d(-100%, 0, 0);
            }

            .get-started-step.right > * {
                transform: translate3d(100%, 0, 0);
            }

            .get-started-thumbs {
                position: absolute;
                bottom: 20px;
                display: flex;
                justify-content: center;
            }

            .get-started-thumbs > * {
                background: var(--color-foreground);
                width: 10px;
                height: 10px;
                border-radius: 100%;
                margin: 5px;
            }

            .get-started-thumbs > .right {
                opacity: 0.3;
            }

            button.skip {
                background: none;
                border: none;
                height: auto;
                line-height: normal;
                font-weight: bold;
                margin-top: 10px;
            }

            :host([open]) {
                pointer-events: none;
            }

            :host([open]) .shutter.top {
                transform: translate3d(0, -100%, 0);
            }

            :host([open]) .shutter.bottom {
                transform: translate3d(0, 100%, 0);
            }
        </style>

        <div class="shutter top"></div>
        <div class="shutter bottom"></div>

        <main class="unlock">

            <pl-icon id="logo" icon="logo" class="hero animate-in animate-out"></pl-icon>

            <div class="form-box tiles tiles-2 animate-in animate-out">
                <pl-input id="passwordInput" type="password" class="tap"
                    select-on-focus on-enter="_unlock" no-tab="[[ open ]]"
                    placeholder="[[ $l('Enter Master Password') ]]"></pl-input>

                <pl-loading-button id="enterButton" on-click="_unlock" class="tap enter-button"
                    label="[[ $l('Unlock') ]]" no-tab="[[ open ]]">
                    <pl-icon icon="forward"></pl-icon>
                </pl-loading-button>
            </div>

            <div class="hint animate-in animate-out" inner-h-t-m-l="[[ _randomHint() ]]"></div>

        </main>

        <main class="get-started">

            <pl-icon icon="logo" class="hero animate"></pl-icon>

            <div class="get-started-steps">

                <div class$="get-started-step [[ _getStartedClass(_getStartedStep, 0) ]]">

                    <div class="welcome-title animate">[[ $l("Welcome to Padlock!") ]]</div>
                    <div class="welcome-subtitle animate">[[ $l("Let's get you set up! It'll take only a couple of seconds.") ]]</div>

                    <div class="form-box tiles tiles-2 animate">
                        <button on-click="_startSetup" class="tap start-button" no-tab="[[ open ]]">
                            <span>[[ $l("Get Started") ]]</span>
                            <pl-icon icon="forward"></pl-icon>
                        </button>
                    </div>

                </div>

                <div class$="get-started-step [[ _getStartedClass(_getStartedStep, 1) ]]">

                    <div class="form-box tiles tiles-2">
                        <pl-input id="emailInput" type="email" select-on-focus no-tab="[[ open ]]"
                            on-enter="_enterEmail" placeholder="[[ $l('Enter Email Address') ]]"></pl-input>

                        <pl-loading-button on-click="_enterEmail" class="tap" no-tab="[[ open ]]">
                            <pl-icon icon="forward"></pl-icon>
                        </pl-loading-button>
                    </div>

                    <div class="hint">
                        <pl-icon icon="cloud"></pl-icon>
                        <span>[[ _getStartedHint(0) ]]</span>
                    </div>

                    <button class="skip" on-click="_skipEmail">[[ $l("Skip Email") ]]</button>

                </div>

                <div class$="get-started-step [[ _getStartedClass(_getStartedStep, 2) ]]">

                    <div class="form-box tiles tiles-2">

                        <pl-input id="newPasswordInput" class="tap" type="password" select-on-focus no-tab="[[ open ]]"
                            on-enter="_enterNewPassword" value="{{ newPwd }}" placeholder="[[ $l('Enter Master Password') ]]"></pl-input>

                        <pl-loading-button id="enterButton" on-click="_enterNewPassword" class="tap enter-button" no-tab="[[ open ]]">
                            <pl-icon icon="forward"></pl-icon>
                        </pl-loading-button>

                    </div>

                    <div class="strength-meter">[[ _pwdStrength ]]</div>

                    <div class="hint">
                        <pl-icon icon="info-round"></pl-icon>
                        <span>[[ _getStartedHint(1) ]]</span>
                    </div>

                </div>

                <div class$="get-started-step [[ _getStartedClass(_getStartedStep, 3) ]]">

                    <div class="form-box tiles tiles-2">

                        <pl-input id="confirmPasswordInput" class="tap" type="password" select-on-focus no-tab="[[ open ]]"
                            on-enter="_confirmNewPassword" placeholder="[[ $l('Confirm Master Password') ]]"></pl-input>

                        <pl-loading-button id="enterButton" on-click="_confirmNewPassword" class="tap enter-button" no-tab="[[ open ]]">
                            <pl-icon icon="forward"></pl-icon>
                        </pl-loading-button>

                    </div>

                    <div class="hint">
                        <pl-icon icon="info-round"></pl-icon>
                        <span>[[ _getStartedHint(2) ]]</span>
                    </div>

                </div>

                <div class$="get-started-step [[ _getStartedClass(_getStartedStep, 4) ]]">

                    <div class="welcome-title">[[ $l("All done!") ]]</div>
                    <div class="welcome-subtitle">[[ $l("You're all set! Have fun!") ]]</div>

                    <div class="form-box tiles tiles-2 animate">
                        <button on-click="_finishSetup" class="tap start-button" no-tab="[[ open ]]">
                            <span>[[ $l("Start Using Padlock") ]]</span>
                            <pl-icon icon="forward"></pl-icon>
                        </button>
                    </div>

                </div>

            </div>

            <div class="get-started-thumbs">
                <div class$="[[ _getStartedClass(_getStartedStep, 0) ]]" on-click="_goToStep"></div>
                <div class$="[[ _getStartedClass(_getStartedStep, 1) ]]" on-click="_goToStep"></div>
                <div class$="[[ _getStartedClass(_getStartedStep, 2) ]]" on-click="_goToStep"></div>
                <div class$="[[ _getStartedClass(_getStartedStep, 3) ]]" on-click="_goToStep"></div>
                <div class$="[[ _getStartedClass(_getStartedStep, 4) ]]" on-click="_goToStep"></div>
            </div>

            <div hidden>
                <pl-loading-button id="getStartedButton" on-click="_getStarted" no-tab="[[ open ]]"
                    class="tap tiles-4 enter-button" label="[[ $l('Get Started') ]]"></pl-loading-button>
            </div>

        </main>

    </template>

    <script src="../../../bower_components/zxcvbn/lib/zxcvbn.js"></script>

    <script>
/* global zxcvbn */
(() => {

const { DataMixin, LocaleMixin, DialogMixin, AnimationMixin, BaseElement } = padlock;
const { applyMixins, wait } = padlock.util;
const { isTouch } = padlock.platform;

const hints = [
    $l(
        "**Did you know**: Padlock Cloud is not only a great way " +
        "to synchronize your data between devices but also acts as a backup in" +
        "case you lose your device or accidentally delete the app. You can find" +
        "your Padlock Cloud settings by clicking on the {0} icon.",
        "<pl-icon icon='cloud'></pl-icon>"
    ),
    $l(
        "**Did you know**: You can generate random values for your fields " +
        "by clicking the {0} icon.",
        "<pl-icon icon='generate'></pl-icon>"
    )
];

class StartView extends applyMixins(
    BaseElement,
    DataMixin,
    LocaleMixin,
    DialogMixin,
    AnimationMixin
) {

    static get is() { return "pl-start-view"; }

    static get properties() { return {
        animationOptions: {
            type: Object,
            value: {
                animation: "reveal",
                duration: 1200,
                fullDuration: 1500,
                initialDelay: 200,
                fill: "both"
            }
        },
        open: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: "_openChanged"
        },
        _getStartedStep: {
            type: Number,
            value: 0
        },
        _hasData: {
            type: Boolean
        },
        _mode: {
            type: String,
            reflectToAttribute: true,
            computed: "_computeMode(_hasData)"
        },
        _pwdStrength: {
            type: String,
            computed: "_passwordStrength(newPwd)"
        }
    }; }

    constructor() {
        super();
        this._failCount = 0;
    }

    ready() {
        super.ready();
        this.dataReady()
            .then(() => this.reset())
            .then(() => {
                if (!isTouch() && this._hasData) {
                    this.$.passwordInput.focus();
                }
            });
    }

    reset() {
        this.$.passwordInput.value = "";
        this.$.emailInput.value = "";
        this.$.newPasswordInput.value = "";
        this.$.enterButton.stop();
        this.$.getStartedButton.stop();
        this._failCount = 0;
        this._hasEmailInputShown = this._hasPasswordInfoShown = false;
        return this._checkHasData();
    }

    _openChanged() {
        if (this.open) {
            this.animateCascade(this.root.querySelectorAll("main:not([hidden]) .animate-out"), {
                direction: "reverse",
                duration: 200,
                fullDuration: 300,
                initialDelay: 0
            });
        } else {
            this.animateCascade(this.root.querySelectorAll("main:not([hidden]) .animate-in"));
        }
    }

    _startSetup() {
        this._getStartedStep = 1;
    }

    _enterEmail() {
        if (this.$.emailInput.invalid) {
            this.alert(this.$.emailInput.validationMessage || $l("Please enter a valid email address!"))
                .then(() => this.$.emailInput.focus());
            return;
        }
        this._getStartedStep = 2;
    }

    _skipEmail() {
        this._getStartedStep = 2;
    }

    _enterNewPassword() {
        const pwd = this.$.newPasswordInput.value;

        if (!pwd) {
            this.alert("Please enter a master password!").then(() => this.$.newPasswordInput.focus());
            return;
        }

        if (zxcvbn(pwd).score < 2) {
            this.confirm($l(
                "WARNING: The password you entered is weak which makes it easier for attackers to break " +
                "the encryption used to protect your data. Try to use a longer password or include a " +
                "variation of uppercase, lowercase and special characters as well as numbers."
            ),
            $l("Use Anyway"), $l("Choose Different Password")).then((confirm) => {
                if (confirm) {
                    this._getStartedStep = 3;
                } else {
                    this.$.newPasswordInput.focus();
                }
            });
            return;
        }

        this._getStartedStep = 3;
    }

    _confirmNewPassword() {
        if (this.$.confirmPasswordInput.value !== this.$.newPasswordInput.value) {
            this.choose($l(
                "The password you entered does not match the original one!"
            ), [
                $l("Try Again"),
                $l("Change Password")
            ])
                .then((choice) => {
                    switch (choice) {
                        case 0:
                            this.$.confirmPasswordInput.focus();
                            break;
                        case 1:
                            this._getStartedStep = 2;
                            this.$.newPasswordInput.focus();
                            break;
                    }
                });
            return;
        }

        this._getStartedStep = 4;
    }

    _computeMode() {
        return this._hasData ? "unlock" : "get-started";
    }

    _checkHasData() {
        return this.hasData()
            .then((has) => this._hasData = has);
    }

    _finishSetup() {
        this._initializeData();
    }

    _initializeData() {
        this.$.getStartedButton.start();
        if (this._initializing) {
            return;
        }
        this._initializing = true;
        this.initData(this.$.newPasswordInput.value, this.$.emailInput.value)
            .then(() => {
                this.$.getStartedButton.success();
                this.$.newPasswordInput.blur();
                this._initializing = false;
            });
    }

    _promptResetData(message) {
        this.prompt(message, $l("Type 'RESET' to confirm"), "text", $l("Reset App"))
            .then((value) => {
                if (value == null) {
                    return;
                }
                if (value.toUpperCase() === "RESET") {
                    this.resetData();
                } else {
                    this.alert($l("You didn't type 'RESET'. Refusing to reset the app."));
                }
            });
    }

    _unlock() {
        const password = this.$.passwordInput.value;

        if (!password) {
            this.alert($l("Please enter your password!")).then(() => this.$.passwordInput.focus());
            return;
        }

        this.$.passwordInput.blur();
        this.$.enterButton.start();

        if (this._unlocking) {
            return;
        }
        this._unlocking = true;

        this.loadData(password)
            .then(() => {
                this.$.enterButton.success();
                this._unlocking = false;
            })
            .catch((e) => {
                this.$.enterButton.fail();
                this._unlocking = false;
                switch (e.code) {
                    case "decryption_failed":
                        this.animateElement(this.$.logo, { animation: "rumble", duration: 200, clear: true });
                        this._failCount++;
                        if (this._failCount > 2) {
                            this._promptResetData($l(
                                "Forgot your master password? You can start over by resetting the app. " +
                                "WARNING: This will delete all your data!"
                            ));
                        } else {
                            this.$.passwordInput.focus();
                        }
                        break;
                    case "unsupported_container_version":
                        this.confirm($l(
                            "It seems the data stored on this device was saved with a newer version " +
                            "of Padlock and can not be opened with the version you are currently running. " +
                            "Please install the latest version of Padlock or reset the data to start over!"
                        ), $l("Check For Updates"), $l("Reset Data"))
                            .then((confirmed) => {
                                if (confirmed) {
                                    padlock.platform.checkForUpdates();
                                } else {
                                    this._promptResetData($l(
                                        "Are you sure you want to reset the app? " +
                                        "WARNING: This will delete all your data!"
                                    ));
                                }
                            });
                        break;
                    default:
                        this._promptResetData($l(
                            "An error occured while loading your data! If the problem persists, please try " +
                            "resetting or reinstalling the app!"
                        ));
                        throw e;
                }
            });
    }

    _showEmailInfo() {
        this.$.emailInput.blur();
        wait(100)
            .then(() => {
                return this.alert($l(
                    "Padlock uses your email address to connect to the Padlock Cloud service, which allows " +
                    "you to easily and securely store your data online and synchronize it between all your devices. " +
                    "Don't worry, we'll only use it as a method of authentication and won't send you any spam!"
                ));
            })
            .then(() => this.$.emailInput.focus());
        this._hasEmailInputShown = true;
    }

    _showPasswordInfo() {
        this.$.newPasswordInput.blur();
        wait(100)
            .then(() => {
                return this.alert($l(
                    "Your master password is a single passphrase that is used to encrypt everything you " +
                    "store in Padlock and the only way to access your data. Without your master password, no " +
                    "one will be able to read your data - not even we! So make sure you don't forget it, because " +
                    "we won't be able to help you recover it in case you do."
                ));
            })
            .then(() => this.$.newPasswordInput.focus());
        this._hasPasswordInfoShown = true;
    }

    _passwordStrength(pwd) {
        const score = pwd ? zxcvbn(pwd).score : -1;
        const strength = score === -1 ? "" : score < 2 ? $l("weak") : score < 4 ? $l("medium") : $l("strong");
        return strength && $l("strength: {0}", strength);
    }

    _hasValue(val) {
        return !!val;
    }

    _emailEnter() {
        this.$.newPasswordInput.focus();
    }

    _randomHint() {
        return hints[Math.floor(Math.random() * hints.length)];
    }

    _getStartedMessage() {
        return $l(
            "**Welcome to Padlock!** Let's get you started! First, choose your master password:"
        );
    }

    _getStartedHint(step) {
        return [
            $l(
                "Padlock uses your email address to connect to the Padlock Cloud service, which allows " +
                "you to easily and securely store your data online and synchronize it between all your devices."
            ),
            $l(
                "Your master password is a single passphrase that will protect " +
                "your data. Without it, nobody will be able to access your data - not even us!"
            ),
            $l(
                "Remember your master password! Without it, nobody will be able to access your data, " +
                "not even we! This is to ensure that your data is as safe as possible but it also means " +
                "that if you lose your master password, we won't be able to assist you with recovering your " +
                "data."
            )
        ][step];
    }

    _getStartedClass(currStep, step) {
        return currStep > step ? "left" : currStep < step ? "right" : "center";
    }

    _goToStep(e) {
        const s = Array.from(this.root.querySelectorAll(".get-started-thumbs > *")).indexOf(e.target);
        if (s < this._getStartedStep) {
            this._getStartedStep = s;
        }
    }

}

window.customElements.define(StartView.is, StartView);

})();
    </script>

</dom-module>
