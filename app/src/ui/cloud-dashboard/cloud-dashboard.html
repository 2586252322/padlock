<link rel="import" href="../../styles/shared.html">
<link rel="import" href="../animation/animation.html">
<link rel="import" href="../base/base.html">
<link rel="import" href="../dialog/dialog-mixin.html">
<link rel="import" href="../icon/icon.html">
<link rel="import" href="../input/input.html">
<link rel="import" href="../loading-button/loading-button.html">
<link rel="import" href="../locale/locale.html">
<link rel="import" href="../notification/notification.html">

<dom-module id="pl-cloud-dashboard">

    <template>

        <style include="shared">
            :host {
                display: flex;
                flex-direction: column;
                @apply --fullbleed;
                background: var(--color-background);
            }
            /*  */
            /* header { */
            /*     --color-background: var(--color-primary); */
            /*     --color-foreground: var(--color-tertiary); */
            /*     --color-highlight: var(--color-secondary); */
            /*     color: var(--color-foreground); */
            /*     background: var(--color-background); */
            /*     text-shadow: rgba(0, 0, 0, 0.2) 0 2px 0; */
            /*     border-bottom: solid 2px rgb(64, 143, 184); */
            /* } */

            button {
                display: block;
                width: 100%;
                box-sizing: border-box;
                /* font-weight: bold; */
            }

            .account {
                font-size: 130%;
                font-weight: bold;
                margin: 10px 0;
                overflow-wrap: break-word;
            }

            .subscription-status {
                font-size: 150%;
                font-weight: bold;
                margin: 10px 0;
            }

            .title.back {
                padding: 0;
                /* margin-left: -10px; */
                font-size: var(--font-size-small);
                flex: none;
            }

            .back-icon {
                font-size: var(--font-size-small);
                width: 30px;
            }

            .title.email {
                text-align: right;
                padding-right: 0;
            }

            .devices {
                line-height: var(--row-height);
            }

            .devices .title {
                text-align: center;
                padding: 0 15px;
                font-weight: bold;
            }

            .device {
                display: flex;
            }

            .device-name {
                flex: 1;
                padding: 0 15px;
                @apply --ellipsis;
            }

            .device > pl-icon {
                width: var(--row-height);
                height: var(--row-height);
            }
        </style>


        <header>
            <pl-icon icon="backward" class="tap back-icon" on-click="_back"></pl-icon>
            <div class="title back">Back To App</div>
            <div class="title email">[[ account.Email ]]</div>
            <pl-icon icon="logout" class="tap" on-click="_logout"></pl-icon>
        </header>

        <main>

            <!-- <section class="tiles"> -->
            <!--     <div class="info"> -->
            <!--         <div class="account">[[ account.email ]]</div> -->
            <!--         <div>Paired Devices: <strong>3</strong></div> -->
            <!--         <div>Last Synced: <strong>August 13, 2017 12:12</strong></div> -->
            <!--     </div> -->
            <!--     <button class="tap" on&#45;click="_resetData">[[ $l("Reset Data") ]]</button> -->
            <!-- </section> -->

            <dom-if if="[[ _isSet(subscription) ]]">

                <template>

                    <section class="tiles" hidden$="[[ !_isTrialing(subscription.status) ]]">
                        <div class="info">
                            <div>[[ $l("Subscription Status:") ]]</div>
                            <div class="subscription-status">[[ $l("Trialing") ]]</div>
                            <div>[[ _trialInfoText() ]]</div>
                        </div>
                        <button class="tap" on-click="_buySubscription">[[ $l("Buy Subscription") ]]</button>
                    </section>

                    <section class="tiles" hidden$="[[ !_isInactive(subscription.status) ]]">
                        <div class="info">
                            <div>[[ $l("Subscription Status:") ]]</div>
                            <div class="subscription-status">[[ $l("Read-Only") ]]</div>
                            <div>[[ _readOnlyInfoText() ]]</div>
                        </div>
                        <button class="tap" on-click="_buySubscription">[[ $l("Buy Subscription") ]]</button>
                    </section>

                    <section class="tiles" hidden$="[[ !_isActive(subscription.status) ]]">
                        <div class="info">
                            <div>[[ $l("Subscription Status:") ]]</div>
                            <div class="subscription-status">[[ $l("Active") ]]</div>
                            <div>[[ connectedInfoText(settings.syncEmail) ]]</div>
                        </div>
                        <button class="tap" on-click="_changePaymentMethod">[[ $l("Payment Method") ]]: <strong>Visa **** **** **** 1234</strong></button>
                    </section>

                </template>

            </dom-if>

            <section class="tiles">
                <div class="info">
                    Want to start from scratch? Here you can reset the data stored in your Padlock Cloud
                    account in case you lost your master password or simply want to start over.
                </div>
                <button class="tap" on-click="_resetData">[[ $l("Delete Data") ]]</button>
            </section>

            <section class="devices">
                <div class="title">[[ $l("{0} Paired Devices", devices.length) ]]</div>

                <div class="tiles tiles-2 device-list">
                    <dom-repeat items="[[ devices ]]">
                        <template>
                            <div class="device tiles">
                                <div class="device-name">[[ item.Description ]]</div>
                                <pl-icon icon="delete"></pl-icon>
                            </div>
                        </template>
                    </dom-repeat>
                </div>

            </section>

        </main>

    </template>

    <script>
(() => {

const { LocaleMixin, DialogMixin, NotificationMixin, AnimationMixin, BaseElement } = padlock;
const { applyMixins } = padlock.util;

class Dashboard extends applyMixins(
    BaseElement,
    LocaleMixin,
    DialogMixin,
    NotificationMixin,
    AnimationMixin
) {

    static get is() { return "pl-cloud-dashboard"; }

    static get properties() { return {
        account: Object,
        subscription: Object,
        action: String,
        paired: Object,
        devices: {
            type: Array,
            computed: "_computeDevices(account.AuthTokens)"
        }
    }; }

    connectedCallback() {
        super.connectedCallback();
        this.animateCascade(this.root.querySelectorAll("section"), { delay: 500 });

        if (this.paired) {
            setTimeout(() => {
                this.notify($l("{0} paired successfully!", this.paired.Description), "info", 3000);
            }, 500);
        }
    }

    _computeDevices() {
        return this.account.AuthTokens.filter((t) => t.Type === "api" && !t.Expired);
    }

    _isSet(val) {
        return !!val;
    }

    _isTrialing() {
        return this.subscription.status === "trialing";
    }

    _isInactive() {
        return this.subscription.status === "inactive";
    }

    _isActive() {
        return this.subscription.status === "active";
    }

    _trialInfoText() {
        return $l(
            "Your trial period ends in {0} days. After this period, your access will be read-only, " +
            "which means you will be able to access your existing data on Padlock Cloud but you won't " +
            "be able to upload any new data or synchronize changes between devices. " +
            "Get a subscription now to get unlimited access to Padlock Cloud!",
            this.remainingTrialDays
        );
    }

    _readOnlyInfoText() {
        return $l(
            "You currently don't have an active subscription which means you can still access " +
            "your existing data on Padlock Cloud but you won't be able to upload any new data " +
            "or synchronize changes between devices. Get a subscription now to take full advantage " +
            "of Padlock Cloud!"
        );
    }

}

window.customElements.define(Dashboard.is, Dashboard);

})();
    </script>

</dom-module>
